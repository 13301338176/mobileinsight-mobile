#include <stdio.h>
#include <fcntl.h>
#include <sys/ioctl.h>
#include <endian.h>
// #include <linux/diagchar.h>

#define USER_SPACE_DATA_TYPE	0x00000020
#define CALLBACK_DATA_TYPE		0x00000080
#define DIAG_IOCTL_SWITCH_LOGGING	7
#define DIAG_IOCTL_REMOTE_DEV		32
#define CALLBACK_MODE	6

const char buf_write1 [] = {
	0x20, 0x00, 0x00, 0x00,	// pkt_type == CALLBACK_DATA_TYPE
	// 0x00, 0x00, 0x00, 0x00,	// remote_proc == -1
	
	0x73, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x0b, 0x00, 0x00, 0x00, 0xc1, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x74, 0xac, 0x7e,

	// 0x73, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x30, 0x01, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x1c, 0x52, 0x7e, 
};

const char buf_write2 [] = {
	0x20, 0x00, 0x00, 0x00,	// pkt_type == CALLBACK_DATA_TYPE
	0x73, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x7d, 0x5d, 0x00, 0x00,
	0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x10, 0x6a, 0x3a, 0x7e, 
};

char buf_read[2000] = {};

void print_hex(const char *buf, int len) {
	int i = 0;
	for (i = 0; i < len; i++) {
		printf("%02x ", buf[i]);
		if (((i + 1) % 16) == 0)
			printf("\n");
	}
	printf("\n");
}

int main () {
	int fd = open("/dev/diag", O_RDWR);
	perror("open");

	int ret = ioctl(fd, DIAG_IOCTL_SWITCH_LOGGING, (char *) CALLBACK_MODE);
	printf("ioctl SWITCH_LOGGING ret: %d\n", ret);

	uint16_t device_mask = 0;
	ret = ioctl(fd, DIAG_IOCTL_REMOTE_DEV, (char *) &device_mask);
	printf("ioctl REMOTE_DEV ret: %d\n", ret);

	printf("Writing %d bytes of data\n", sizeof(buf_write1));
	print_hex(buf_write1, sizeof(buf_write1));
	write(fd, (const void *) buf_write1, sizeof(buf_write1));
	perror("write");

	printf("Writing %d bytes of data\n", sizeof(buf_write2));
	print_hex(buf_write2, sizeof(buf_write2));
	write(fd, (const void *) buf_write2, sizeof(buf_write2));
	perror("write");

	while (1) {
		int ign = read(fd, buf_read, 1000);
		if (ign > 0) {
			printf("%d\n", ign);
			print_hex(buf_read, ign);
			// printf("0x%x ", buf_read[0]);
		} else {
			continue;
		}
	}
	printf("\nend\n");

	close(fd);
	return (ret < 0? ret: 0);
}
